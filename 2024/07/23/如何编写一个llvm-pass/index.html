<!DOCTYPE html>
<html>
  <head>
     
    <meta charset="UTF-8">
    <title>如何编写一个llvm pass - kw&#39;s blog</title>
    <link rel="shortcut icon" href="/static/img/icon.png">
    <link rel="icon" href="/static/img/icon.png" sizes="192x192"/>
    
<link rel="stylesheet" href="/static/kico.css">
<link rel="stylesheet" href="/static/hingle.css">

    
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <meta name="viewport" content="width=device-width, maximum-scale=1, initial-scale=1"/>
    <meta property="og:site_name" content="kw&#39;s blog">
    <meta property="og:title" content="如何编写一个llvm pass"/>
    
    <style>body:before{ content: ''; background-image: url(https://api.paugram.com/wallpaper?source=gh) }</style>
    
<meta name="generator" content="Hexo 6.3.0"></head>

  <body>
    <header>
    <div class="head-title">
        <h4>kw&#39;s blog</h4>
    </div>
    <div class="head-action">
        <div class="toggle-btn"></div>
        <div class="light-btn"></div>
        <div class="search-btn"></div>
    </div>
    <form class="head-search" method="post">
        <input type="text" name="s" placeholder="搜索什么？">
    </form>
    <nav class="head-menu">
        <a href="/">首页</a>
        <div class="has-child">
            <a>分类</a>
            <div class="sub-menu">
                
            </div>
        </div>
        
            <a href="/about">关于我</a>
        
            <a href="/friends">朋友们</a>
        
    </nav>
</header>

    <main>
    <div class="wrap min">
        <section class="post-title">
            <h2>如何编写一个llvm pass</h2>
            <div class="post-meta">
                <time class="date">2024.07.23</time>
            
            </div>
        </section>
        <article class="post-content">
        
            <h2 id="一-配置环境"><a href="#一-配置环境" class="headerlink" title="一.配置环境"></a>一.配置环境</h2><p>配置环境的话指路whitebird大佬的博客：</p>
<p><a target="_blank" rel="noopener" href="https://whitebird0.github.io/post/%E4%BB%8Ellvm%E5%88%B0ollvm%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html">https://whitebird0.github.io/post/%E4%BB%8Ellvm%E5%88%B0ollvm%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html</a></p>
<p>或者llvm的官方文档<a target="_blank" rel="noopener" href="https://llvm.org/docs/GettingStarted.html">https://llvm.org/docs/GettingStarted.html</a></p>
<h2 id="二-注意的点"><a href="#二-注意的点" class="headerlink" title="二.注意的点"></a>二.注意的点</h2><p>一个是whitebird博客中是使用clion对llvm进行编译，在编译过程中如果llvm是在虚拟机上的话要在clion的设置中将toolchain换一下，从windows换成wsl</p>
<p>二是大佬用的是旧版指令和编写llvm pass 的方式，新版已经不能使用他博客中的方式编写</p>
<h2 id="三-正式开始"><a href="#三-正式开始" class="headerlink" title="三.正式开始"></a>三.正式开始</h2><p>首先入门可以查看官方文档，根据官方文档进行llvm pass的编写</p>
<p>![](<a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/kw171/kw171.github.io/img/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE">https://raw.githubusercontent.com/kw171/kw171.github.io/img/屏幕截图</a> 2024-07-24 121209.png)</p>
<p>可以发现其实官方文档所写的helloworld.h已经被创建了，那么我们根据他再在该文件夹中创建一个encode.h</p>
<p>写出如下代码:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> LLVM_TRANSFORMS_UTILS_ENCODE_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LLVM_TRANSFORMS_UTILS_ENCODE_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/PassManager.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">namespace llvm &#123;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EncodePass</span> :</span> public PassInfoMixin&lt;EncodePass&gt; &#123;</span><br><span class="line">public:</span><br><span class="line">  PreservedAnalyses <span class="title function_">run</span><span class="params">(Function &amp;F, FunctionAnalysisManager &amp;AM)</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125; <span class="comment">// namespace llvm</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// LLVM_TRANSFORMS_UTILS_ENCODE_H</span></span></span><br></pre></td></tr></table></figure>

<p>这段代码写完可能会有run标红，不用管，否则编译opt的时候会报错</p>
<p>然后再在llvm&#x2F;lib&#x2F;Transforms&#x2F;Utils中创建Encode.cpp,代码如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Transforms/Utils/Encode.h&quot;</span></span></span><br><span class="line">using namespace llvm;</span><br><span class="line">PreservedAnalyses <span class="title function_">EncodePass::run</span><span class="params">(Function &amp;F,</span></span><br><span class="line"><span class="params">                                      FunctionAnalysisManager &amp;AM)</span> &#123;</span><br><span class="line">  errs() &lt;&lt; F.getName() &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">  <span class="keyword">return</span> PreservedAnalyses::all();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在llvm&#x2F;lib&#x2F;Transforms&#x2F;Utils的Cmakelists.txt中添加一个Encode.cpp</p>
<p>写完后在llvm&#x2F;lib&#x2F;Passes&#x2F;PassRegistry.def中添加如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FUNCTION_PASS(&quot;encode&quot;,EncodePass())</span><br></pre></td></tr></table></figure>

<p>在llvm&#x2F;lib&#x2F;Passes&#x2F;PassBuilder.cpp添加</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#include &quot;llvm/Transforms/Utils/Encode.h&quot;</span><br></pre></td></tr></table></figure>

<p>然后在clion中重新编译</p>
<p>![](<a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/kw171/kw171.github.io/img/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE">https://raw.githubusercontent.com/kw171/kw171.github.io/img/屏幕截图</a> 2024-07-25 120615.png)</p>
<p>选择重新加载cmake项目</p>
<p>然后进入cmake-build-release文件夹重新编译</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ninja -j2 opt</span><br></pre></td></tr></table></figure>

<p>不过编译过程中我莫名其妙跳出来一个循环依赖问题</p>
<p>![](<a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/kw171/kw171.github.io/img/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE">https://raw.githubusercontent.com/kw171/kw171.github.io/img/屏幕截图</a> 2024-07-25 115432.png)</p>
<p>不过解决也很容易，只要在clion中进入lib&#x2F;support&#x2F;BLAKE3&#x2F;里面的cmakelists.txt，把最后一行和Encode.cpp有关的内容删除即可（虽然我还不知道有什么影响，不过好像没什么影响）</p>
<p>然后编译完成就可以使用opt将pass用于我们的IR代码上啦</p>
<h2 id="四-使用pass"><a href="#四-使用pass" class="headerlink" title="四.使用pass"></a>四.使用pass</h2>
        </article>
        <section class="post-near">
            <ul>
                
                    <li>上一篇: 看完啦 (つд⊂)</li>
                
                
                    <li>下一篇: <a href="/2024/01/19/name/">name</a></li>
                
            </ul>
        </section>
        
    
        <section class="post-author">
        
            <figure class="author-avatar">
                <img src="/static/img/1.jpg" alt="kwww" />
            </figure>
        
            <div class="author-info">
                <h4>kwww</h4>
                <p>我是一只菜狗</p>
            </div>
        </section>
    
    </div>
</main>

    <footer>
    <div class="buttons">
        <a class="to-top" href="#"></a>
    </div>
    <div class="wrap min">
        <section class="widget">
            <div class="row">
                <div class="col-m-4">
                    <h3 class="title-recent">最新文章：</h3>
                    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2024/07/23/%E5%A6%82%E4%BD%95%E7%BC%96%E5%86%99%E4%B8%80%E4%B8%AAllvm-pass/">如何编写一个llvm pass</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/01/19/name/">name</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/01/19/my-new-page/">my new page</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/01/19/hello-world/">Hello World</a></li></ul>
                </div>
                <div class="col-m-4">
                    <h3 class="title-date">时光机：</h3>
                    <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/07/">七月 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/01/">一月 2024</a></li></ul>
                </div>
                <div class="col-m-4">
                    <h3 class="title-tags">标签云：</h3>
                    
                </div>
            </div>
        </section>
        <section class="sub-footer">
            <p>© 2024 <a href="/">kw&#39;s blog</a>. All Rights Reserved. Theme By <a href="https://github.com/Dreamer-Paul/Hingle" target="_blank" rel="nofollow">Hingle</a>.</p>
        </section>
    </div>
</footer>


<script src="/static/kico.js"></script>
<script src="/static/hingle.js"></script>


<script>var hingle = new Paul_Hingle({"copyright":true,"night":true});</script>

  <script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/love.js"></script>
<!--动态线条背景-->
<script type="text/javascript"
color="220,220,220" opacity='0.7' zIndex="-2" count="200" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js">
</script>
